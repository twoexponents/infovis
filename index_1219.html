<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <style>
    body {
      background-color: white;
    }
    .axis path,
    .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
      stroke-width: 1px;
    }
    svg {
      /*border: 1px solid gray;*/
      /*background-color: white;*/
      position: absolute;
      border-radius: 10px;
    }
    .boundary {
      fill: #ECEFF1;
      stroke: #607D8B;
      stroke-width: 1px;
    }
    .hidden {
      display: none;
    }
    .var_bars:hover {
      filter: brightness(120%);
    }
    .win_bars:hover {
      filter: brightness(120%);
    }
    div.tooltip {
	    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
	    font-size: 15px;
	    font-style: normal;
	    font-weight: bold;
      color: #222;
      background: #fff;
      border-radius: 4px;
      box-shadow: 0px 0px 2px 0px #a6a6a6;
      padding: .3em;
      text-shadow: #f5f5f5 0 1px 0;
      opacity: 0.9;
      z-index: 10;
      position: absolute;
    }
    #legend-svg {
      vertical-align: top;
      position: absolute;
    }

    .arc text {
    font: 10px sans-serif;
    text-anchor: middle;
    }

    .arc path {
    stroke: #fff;
    }

    .pText text{
      font: 14px sans-serif;
      text-anchor: middle;
      padding-right: 10px;
    }

    .xaxis line {
      fill: none;
      stroke: #999;
      stroke-width: 1px;
      shape-rendering: crispEdges;
    }

    .xaxis path {
      fill: none;
      stroke: none;
    }

    .yaxis line {
      fill: none;
      stroke: #999;
      stroke-width: 1px;
      shape-rendering: crispEdges;
    }

    .yaxis path {
      fill: none;
      stroke: none;
    }
  </style>
</head>

<body>
  <div id="filter" style="display:flex; flex-direction: row; flex-end: center; align-items: center" >
    <p class="pText"><text>Rating</text>
    <input type="range" min="70" max="100" step="1" value="70" id="range" style="vertical-align: middle"/>
    <text class="pText" id="slider" style="color: gray">70</text>
    </p>
    <p class="pText"><text>Price</text>
    <input id="min" class="select" type="number" placeholder="minimum price" name="min"/> ~
    <input id="max" class="select" type="number" placeholder="maximum price" name="max"/>
    </p>
    <input type="button" value="SEARCH" id="button"/>
  </div>
<div id="map"></div>
<div style="position: absolute; top:670px; left:950px">
<form id="dimension">
  <input type='radio' id="price" name="mode" checked="true"><text style="font-family: sans-serif">price</text></input>
  <input type='radio' id="rating" name="mode" ><text style="font-family: sans-serif">rating</text></input>
</form></div>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script>
  <script>

/////////////// Global Variables & Plots
    var width = 1100, rotated = 205, height = 600;
    var usa, states; //track states
    var initX; //track where mouse was clicked
    var s = 1; //track scale only rotate when s === 1
    var mouseClicked = false;
    var viewDegree = "country";
    var rotateVal = 0;
    var ctr_records = [];
    var currentCtr;
    var fList;
    var country_id;
    var state_list = [];

    var projection = d3.geo.mercator()
        .scale(170)
        .translate([width/2,height/1.5])
        .rotate([rotated,0,0]); //center on USA because 'murica

    var zoom = d3.behavior.zoom()
         .scaleExtent([1, 20])
         .on("zoom", zoomed);

    //var filter = d3.select("body").append("svg")

    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height)
        .style('top', '60px')
          //track where user clicked down
          .on("mousedown", function() {
             d3.event.preventDefault();
             //only if scale === 1
             if(s !== 1) return;
               initX = d3.mouse(this)[0];
               mouseClicked = true;
          })
          .on("mouseup", function() {
              if(s !== 1) return;
              rotated = rotated + ((d3.mouse(this)[0] - initX) * 360 / (s * width));
              mouseClicked = false;
          })
        .call(zoom)
        .style('border', '1px solid gray');

    //for tooltip
    var offsetL = document.getElementById('map').offsetLeft+10;
    var offsetT = document.getElementById('map').offsetTop+10;
    var path = d3.geo.path().projection(projection);
    var tooltip = d3.select("#map")
         .append("div")
         .attr("class", "tooltip hidden");

    var g = svg.append("g"); //need this for correct panning

    //for drawing color
    var myColorScales = ['#FFE8CE', '#FFDBB2', '#FFCB8E', '#FFBE73', '#FFB157', '#FFA63F', '#FF9B28'];
    var myColorScales2 = ['#D5B7D5', '#C071C0', '#B050B0', '#871A87', '#720372']

    //filter
    var min = d3.select('#min');
    var max = d3.select('#max');
    d3.select("input[type=range]#range").on("input", function() {
      var point;
      point = this.value;
      d3.select("text#slider").text(point);
    });


    function linespace(start, end, n) {
      var out = [];
      var delta = (end - start) / (n - 1);
      var i =0;
      while(i < (n - 1)) {
        out.push(start + (i * delta));
        i++;
      }
      out.push(end);
      return out;
    }
    let radiusScale; //region point radius range
    let popScale; //country color range
    let popScale2; //region color range

    let country_plot1 = d3.select('body').append('svg') // first graph
        .attr('width', 545)
        .attr('height', 500)
        .style('top', '665px');
    let country_plot2 = d3.select('body').append('svg') // second graph
        .attr('width', 545)
        .attr('height', 475)
        .style('top', '690px')
        .style('left', '560px')
    let variety_plot = d3.select('body').append('svg') // first graph
        .attr('width', 670)
        .attr('height', 550)
        .style('top', '60px')
        .style('left', '1130px');
    let winery_plot = d3.select('body').append('svg') // second graph
        .attr('width', 670)
        .attr('height', 545)
        .style('top', '620px')
        .style('left', '1130px');

    var fullData;

    d3.select('#button').on('click', function(){
        console.log("button search clicked.");
        fList = filter(fullData);
        drawing();

        var id = currentCtr;
        var ffList = countryFilter(fList, id)
        var newstat = countryStat(ffList);
        countryChartUpdate(newstat)
        if (!init) {
          console.log(fList)
          regionStat(id, currentReg, fList)
        }
    });

    d3.json("data/country_id.json", function(error, idData) {
    	console.log("Load country_id json file");
    	country_id = idData;
    })

    // hmlee
    // Assume that filtered data is fed
    d3.json("data/wine_full.json", function(error, data) {
    	console.log("Load wine data json file.");

    	if(error) return console.error(error)

    	fullData = data;
      drawing();
    });

    function drawing() {
      if(fList === undefined)
        fList = fullData;

      ctr_records = [];

      // jhlim: make ctr_records json
      for(var i=0; i<country_id.length; i++) {
          var records = {};
          records["id"] = country_id[i].id;
          records["values"] = fList.filter( function(d) {
              return d.ctr_code == country_id[i].id } )
          var temp = fList.filter(function(d) {
              return d.ctr_code == country_id[i].id } );
          records["provinces"] = countryStatAll(country_id[i].id, temp);
          ctr_records.push(records);
      }
      console.log(ctr_records);


        //country_stat = countryStat(country_filtered)

        popScale = d3.scale.linear()
            .domain(linespace(
              d3.min(ctr_records, function(d) {
                if(d.values.length === 0) return 0;
                else return Math.log10(+d.values.length);
              }),
              d3.max(ctr_records, d=>Math.log10(+d.values.length)),
              myColorScales.length))
            .range(myColorScales);

	popScale2 = d3.scale.linear()
            .domain(linespace(
              d3.min(ctr_records, d => d3.min(d.provinces, e => e.rating)),
              d3.max(ctr_records, d => d3.max(d.provinces, e => e.rating)),
              myColorScales2.length))
            .range(myColorScales2);

        radiusScale = d3.scale.linear()
            .domain([
              d3.min(ctr_records, function(e) {
                return d3.min(e.provinces, d => d.record_count)}),
              d3.max(ctr_records, function(e) {
                return d3.max(e.provinces, d => d.record_count)})])
            .rangeRound([1.5, 4]);


        regionPoint();
        if(viewDegree === 'country') {
          countryFill();
          regionPointHidden();
          drawLegend();
        }
    }

    // jhlim
    // Draw a map
    d3.json("combined3.json", function(error, world) {
      if(error) return console.error(error);

      //countries
      g.append("g")
        .attr("class", "boundary")
        .selectAll("boundary")
        .data(topojson.feature(world, world.objects.countries).features)
        .enter().append("path")
        .attr("class", "country")
        .attr("name", function(d) {return d.properties.name;})
        .attr("id", function(d) { return d.id;})
        .on('click', selected)
        .on("mousemove", showTooltip)
        .on("mouseout",  function(d,i) {
            tooltip.classed("hidden", true);
         })
        .attr("d", path);

      usa = d3.select('#USA');

      //states
      g.append("g")
        .attr("class", "boundary state hidden")
        .selectAll("boundary")
        .data(topojson.feature(world, world.objects.states).features)
        .enter().append("path")
        .attr("class", "state")
        .attr("name", function(d) {
          state_list.push(d.properties.name);
          return d.properties.name;})
        .attr("id", function(d) { return d.id;})
        .on("click", selected)
        .on("mousemove", showTooltip)
        .on("mouseout",  function(d,i) {
            tooltip.classed("hidden", true);
         })
        .attr("d", path);

      states = d3.selectAll('.state');
      countries = d3.selectAll('.countries');

    });

    function zoomed() {
      var t = d3.event.translate;
      s = d3.event.scale;
      var h = 0;

      t[0] = Math.min(
        (width/height)  * (s - 1),
        Math.max( width * (1 - s), t[0] )
      );

      t[1] = Math.min(
        h * (s - 1) + h * s,
        Math.max(height  * (1 - s) - h * s, t[1])
      );

      zoom.translate(t);
      if(s === 1 && mouseClicked) {
        rotateMap(d3.mouse(this)[0])
        return;
      }

      g.attr("transform", "translate(" + t + ")scale(" + s + ")");

      //adjust the stroke width based on zoom level
      d3.selectAll(".boundary")
        .style("stroke-width", 1 / s);

      //User zoom in, zoom out
      if(s > 2.4) {
        zoomIn();
      } else {
        zoomOut();
      }
    }

    function barTooltip(d) {
      label = "TEST"
      //label = d.variety + '</br>' + '# of records: ' + d.record_count;
        var mouse = d3.mouse(svg.node())
          .map( function(d) { return parseInt(d); })
        tooltip.classed("hidden", false)
          .attr("style", "left:"+(mouse[0]+offsetL)+"px;top:"+(mouse[1]+offsetT)+"px")
          .html(label);
    }

    function barMouseOver(d) {

      d3.select(this.parentNode).append("text")
         .attr('x', 140)
         .attr('y', function() {
            let margin;
            if (d.total == 1) {
              return d.rank * 70 + 122
            }
            if (d.total == 2) {
              return d.rank * 174 + 122
            }
            if (d.total == 3) {
              return d.rank * 116 + 122
            }
            if (d.total == 4) {
              return d.rank * 87 + 122
            }
            else {
              return d.rank * 70 + 122
            }
          })
         .style("font-family", "sans-serif")
         .style("font-size", "18px")
         .attr('class', 'barCount')
         .text("Avg. Price: " + d3.format("$.2f")(d.price));
    }

    function barMouseOut() {
      d3.selectAll('.barCount').remove()
    }

    function countryChart(id){
      // console.log(getCountryData(id));
      var list = countryFilter(fList, id)
      var ffList = filter(list)
      var stat = countryStat(ffList);

      //pie chart
      var width = 545,
      height = 500,
      radius = Math.min(width, height) / 2;

      var color = d3.scale.ordinal()
          .range(["#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c"]);

      var arc = d3.svg.arc()
          .outerRadius(radius)
          .innerRadius(radius * 0.4);

      var labelArc = d3.svg.arc()
          .outerRadius(radius * 0.5)
          .innerRadius(radius);

      var pie = d3.layout.pie()
          .sort(null)
          .value(function(d) { return d.record_count; });

      var svg = country_plot1
          .attr("id", id)
          .append("g")
          .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

      var title = country_plot1
      	  .append('text')
      	  .attr("id", 'pieTitle')
      	  .text(ffList[0].country)
      	  .style("font-size", "20px")
      	  .style("font-weight", "bold")
      	  .style("font-family", "sans-serif")
      	  .style("text-anchor", "middle")
	  .attr("transform", translate(width/2, height/2));

      var g = svg.selectAll(".arc")
          .data(pie(stat), d=>d.data.province)
          .enter().append("g")
          .attr("class", "arc");

      g.append("path")
          .attr("d", arc)
          .style("fill", function(d) { return color(d.data.province); });

      g.append("text")
          .attr("transform", function(d) { return "translate(" + labelArc.centroid(d) + ")"; })
          .attr("dy", ".3em")
          .text(function(d) { return d.data.province; });

      //bar chart
      var form = d3.select("#dimension").selectAll("input");
      var form_val;
      form.each(function(d){
        if(d3.select(this).property('checked')){
          form_val = d3.select(this).property('id')
        }
      })

      d3.selectAll("input[type=radio]")
      .on('change', change);

      var chart = country_plot2
            .append("g")
            .attr("id", "bars")
            .attr("transform", "translate(" + 30 + "," + 20 + ")");

        var x = d3.scale.ordinal()
            .domain(stat.map(function(d) { return d.province; }))
            .rangeRoundBands([0, 500], .1);

        var y;

        if(form_val === 'price'){
          y = d3.scale.linear()
              .domain([0, d3.max(stat, function(d) { return d.price; }) * 1.1])
              .range([420, 0]);
        } else{
          y = d3.scale.linear()
              .domain([0, d3.max(stat, function(d) { return d.rating; }) * 1.1])
              .range([420, 0]);
        }

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

        chart.append("g")
            .attr("class", "xaxis")
            .attr("transform", "translate(0," + 420 + ")")
            .call(xAxis)
            .selectAll("text")
            .style("font-size","12px")
            .style("font-family", "sans-serif");

        chart.append("g")
            .attr("class", "yaxis")
            .call(yAxis)
            .selectAll("text")
            .style("font-size","12px")
            .style("font-family", "sans-serif");

        if(form_val === 'price'){
          var bar = chart.selectAll(".bar")
              .data(stat, d=>d.province)
              .enter().append("rect")
              .attr("class", "bar")
              .attr("x", function(d) { return x(d.province); })
              .attr("y", function(d) { return y(d.price); })
              .attr("width", x.rangeBand())
              .attr("height", 0)
              .style("fill", function(d) { return color(d.province); });

          bar.transition()
              .duration(1000)
              .ease("elastic")
              .attr("y", function(d) { return y(d.price); })
              .attr("height", function(d) { return 420 - y(d.price); })

          var bText = chart.append("g")
              .attr("class", "tvalues").selectAll(".tvalue").data(stat, d=>d.province);

          bText.enter().append("text")
              .attr("class", "tvalue")
              .attr("x", function(d){return x(d.province);})
              .attr("dy", ".95em")
              .attr("dx", ".5em")
              .attr("y", 0)
              .text(function(d) { return d3.format("$.2f")(d.price);})
              .style("font-family", "sans-serif")
              .style("font-size","12px");

          bText.transition().duration(1000)
              .attr("y", function(d){return y(d.price) ;});

          d3.selectAll(".tvalues").attr("transform", "translate(" + 0 + "," + -30 + ")");
        } else{
          var bar = chart.selectAll(".bar")
              .data(stat, d=>d.province)
              .enter().append("rect")
              .attr("class", "bar")
              .attr("x", function(d) { return x(d.province); })
              .attr("y", function(d) { return y(d.rating); })
              .attr("width", x.rangeBand())
              .attr("height", 0)
              .style("fill", function(d) { return color(d.province); });

          bar.transition()
              .duration(1000)
              .ease("elastic")
              .attr("y", function(d) { return y(d.rating); })
              .attr("height", function(d) { return 420 - y(d.rating); })

          var bText = chart.append("g")
              .attr("class", "tvalues").selectAll(".tvalue").data(stat, d=>d.province);

          bText.enter().append("text")
              .attr("class", "tvalue")
              .attr("x", function(d){return x(d.province);})
              .attr("dy", ".95em")
              .attr("dx", ".5em")
              .attr("y", 0)
              .text(function(d) { return d3.format("0.2f")(d.rating);})
              .style("font-family", "sans-serif")
              .style("font-size","12px");

          bText.transition().duration(1000)
              .attr("y", function(d){return y(d.rating) ;});

          d3.selectAll(".tvalues").attr("transform", "translate(" + 0 + "," + -30 + ")");
        }

        function change(){
          var value = this.id;

          var chart = d3.select("#bars")

          var x = d3.scale.ordinal()
              .domain(stat.map(function(d) { return d.province; }))
              .rangeRoundBands([0, 500], .1);

          var y;

          if(value == "price"){
            y = d3.scale.linear()
                .domain([0, d3.max(stat, function(d) { return d.price; }) * 1.1])
                .range([420, 0]);
          } else{
            y = d3.scale.linear()
                .domain([70, d3.max(stat, function(d) { return d.rating; }) * 1.1])
                .range([420, 0]);
          }

          var xAxis = d3.svg.axis()
              .scale(x)
              .orient("bottom");

          var yAxis = d3.svg.axis()
              .scale(y)
              .orient("left");

          chart.select(".xaxis")
              .transition().duration(1000)
              .call(xAxis)
              .selectAll("text")
              .style("font-size","12px")
              .style("font-family", "sans-serif");

          chart.select(".yaxis")
              .transition().duration(1000)
              .call(yAxis)
              .selectAll("text")
              .style("font-size","12px")
              .style("font-family", "sans-serif");

          var bar = chart.selectAll(".bar")
              .data(stat, d=>d.province);

          if(value == "price"){
            bar.enter().append("rect")
                .attr("class", "bar")
                .attr("x", function(d) { return x(d.province); })
                .attr("y", function(d) { return y(d.price); })
                .attr("width", x.rangeBand())
                .attr("height", 0)
                .transition().duration(1000)
                .style("fill", function(d) { return color(d.province); });

            bar.each(function(d){
              d3.select(this).transition().duration(1000)
                .attr("x", function(d) { return x(d.province); })
                .attr("y", function(d) { return y(d.price); })
                .attr("height", function(d) { return 420 - y(d.price); })
            })

            var text = chart.selectAll(".tvalue")
                .transition().duration(1000)
                .attr("x", function(d){ return x(d.province);})
                .attr("y", function(d){return y(d.price) ;})
                .text(function(d) { return d3.format("$.2f")(d.price);})
                .style("font-family", "sans-serif")
                .style("font-size","12px");

            text.each(function(d){
              d3.select(this).transition().duration(1000)
                .attr("x", function(d){ return x(d.province);})
                .attr("y", function(d){return y(d.price) ;})
                .text(function(d) { return d3.format("$.2f")(d.price);})
            })

            d3.selectAll(".tvalues").attr("transform", "translate(" + 0 + "," + -30 + ")");

          } else{
            bar.enter().append("rect")
                .attr("class", "bar")
                .attr("x", function(d) { return x(d.province); })
                .attr("y", function(d) { return y(d.rating); })
                .attr("width", x.rangeBand())
                .attr("height", 0)
                .transition().duration(1000)
                .style("fill", function(d) { return color(d.province); });

            bar.each(function(d){
              d3.select(this).transition().duration(1000)
                .attr("x", function(d) { return x(d.province); })
                .attr("y", function(d) { return y(d.rating); })
                .attr("height", function(d) { return 420 - y(d.rating); })
            })

            var text = chart.selectAll(".tvalue")
                .transition().duration(1000)
                .attr("x", function(d){ return x(d.province);})
                .attr("y", function(d){return y(d.rating) ;})
                .text(function(d) { return d3.format("0.2f")(d.rating);})
                .style("font-family", "sans-serif")
                .style("font-size","12px");

            text.each(function(d){
              d3.select(this).transition().duration(1000)
                .attr("x", function(d){ return x(d.province);})
                .attr("y", function(d){return y(d.rating) ;})
                .text(function(d) { return d3.format("0.2f")(d.rating);})
            })

            d3.selectAll(".tvalues").attr("transform", "translate(" + 0 + "," + -30 + ")");
          }
        }

    }

    function countryChartUpdate(newstat){

      var color = d3.scale.ordinal()
          .range(["#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c"]);

          //pie chart
          var width = 545,
          height = 500,
          radius = Math.min(width, height) / 2;

          var arc = d3.svg.arc()
              .outerRadius(radius)
              .innerRadius(radius * 0.4);

          var labelArc = d3.svg.arc()
              .outerRadius(radius * 0.5)
              .innerRadius(radius);

          var pie = d3.layout.pie()
              .sort(null)
              .value(function(d) { return d.record_count; });

          var svg = country_plot1.select("g")

          var g = svg.selectAll(".arc")
              .data(pie(newstat), d=>d.data.province)

          var path = g.enter().append('g')
              .attr("class", "arc")
              .selectAll("path").data(pie(newstat), d=>d.data.province)

          path.enter().append("path")
              .attr("d", arc)
              .style("fill", function(d) { return color(d.data.province); })

          g.each(function(d){
            d3.select(this).selectAll('path')
              .data(pie(newstat), d=>d.data.province)
              .attr("d", arc)
              .style("fill", function(d) { return color(d.data.province); });
          })

          g.exit().remove();

          g = svg.selectAll(".arc")
              .data(pie(newstat), d=>d.data.province)

          var text = g.selectAll("text").data(pie(newstat), d=>d.data.province);

          text.enter().append("text")
              .transition().duration(1000)
              .attr("transform", function(d) { return "translate(" + labelArc.centroid(d) + ")"; })
              .attr("dy", ".3em")
              .text(function(d) { return d.data.province; });

          text.each(function(d){
            d3.select(this).transition().duration(1000)
              .attr("transform", function(d) { return "translate(" + labelArc.centroid(d) + ")"; })
              .attr("dy", ".3em")
              .text(function(d) { return d.data.province; });
          })

          text.exit().remove()

      //bar chart
      var form = d3.select("#dimension").selectAll("input");
      var value;
      form.each(function(d){
        if(d3.select(this).property('checked')){
          value = d3.select(this).property('id')
        }
      })

      d3.selectAll("input[type=radio]")
      .on('change', change);

      var chart = country_plot2.selectAll("#bars")

      var x = d3.scale.ordinal()
          .domain(newstat.map(function(d) { return d.province; }))
          .rangeRoundBands([0, 500], .1);

      var y;

      if(value == "price"){
        y = d3.scale.linear()
            .domain([0, d3.max(newstat, function(d) { return d.price; }) * 1.1])
            .range([420, 0]);
      } else{
        y = d3.scale.linear()
            .domain([70, d3.max(newstat, function(d) { return d.rating; }) * 1.1])
            .range([420, 0]);
      }

      var xAxis = d3.svg.axis()
          .scale(x)
          .orient("bottom");

      var yAxis = d3.svg.axis()
          .scale(y)
          .orient("left");

      chart.select(".xaxis")
          .transition().duration(1000)
          .call(xAxis)
          .selectAll("text")
          .style("font-size","12px")
          .style("font-family", "sans-serif");

      chart.select(".yaxis")
          .transition().duration(1000)
          .call(yAxis)
          .selectAll("text")
          .style("font-size","12px")
          .style("font-family", "sans-serif");

      var bar = chart.selectAll(".bar")
          .data(newstat, d=>d.province);

      if(value == "price"){
        bar.enter().append("rect")
            .attr("class", "bar")
            .attr("x", function(d) { return x(d.province); })
            .attr("y", function(d) { return y(d.price); })
            .attr("width", x.rangeBand())
            .attr("height", 0)
            .style("fill", function(d) { return color(d.province); })
            .transition().duration(1000);

        bar.each(function(d){
          d3.select(this).transition().duration(1000)
            .attr("x", function(d) { return x(d.province); })
            .attr("y", function(d) { return y(d.price); })
            .attr("width", x.rangeBand())
            .attr("height", function(d) { return 420 - y(d.price); })
        })

        bar.exit().remove();

        var g = chart.select(".tvalues")

        var text = g.selectAll(".tvalue")
            .data(newstat, d=>d.province);

        text.enter().append("text")
            .attr("class", "tvalue")
            .attr("x", function(d){ return x(d.province);})
            .attr("y", function(d){return y(d.price) ;})
            .text(function(d) { return d3.format("$.2f")(d.price);})
            .style("font-family", "sans-serif")
            .style("font-size","12px")
            .transition().duration(1000);

        text.each(function(d){
          d3.select(this).transition().duration(1000)
            .attr("x", function(d){ return x(d.province);})
            .attr("y", function(d){return y(d.price) ;})
            .text(function(d) { return d3.format("$.2f")(d.price);})
        })

        text.exit().remove();

        d3.selectAll(".tvalues").attr("transform", "translate(" + 0 + "," + -30 + ")");

      } else{
        bar.enter().append("rect")
            .attr("class", "bar")
            .attr("x", function(d) { return x(d.province); })
            .attr("y", function(d) { return y(d.rating); })
            .attr("width", x.rangeBand())
            .attr("height", 0)
            .style("fill", function(d) { return color(d.province); })
            .transition().duration(1000);

        bar.each(function(d){
          d3.select(this).transition()
            .duration(1000)
            .attr("x", function(d) { return x(d.province); })
            .attr("y", function(d) { return y(d.rating); })
            .attr("width", x.rangeBand())
            .attr("height", function(d) { return 420 - y(d.rating); })
        })

        var g = chart.select(".tvalues");

        var text = g.selectAll(".tvalue")
            .data(newstat, d=>d.province)

        text.enter().append("text")
            .attr("class", "tvalue")
            .attr("x", function(d){ return x(d.province);})
            .attr("y", function(d){return y(d.rating) ;})
            .text(function(d) { return d3.format("0.2f")(d.rating);})
            .style("font-family", "sans-serif")
            .style("font-size","12px")
            .transition().duration(1000);

        text.each(function(d){
          d3.select(this).transition().duration(1000)
            .attr("x", function(d){ return x(d.province);})
            .attr("y", function(d){return y(d.rating) ;})
            .text(function(d) { return d3.format("0.2f")(d.rating);})
        })

        d3.selectAll(".tvalues").attr("transform", "translate(" + 0 + "," + -30 + ")");
      }

      function change(){
        var value = this.id;

        var chart = d3.select("#bars")

        var x = d3.scale.ordinal()
            .domain(newstat.map(function(d) { return d.province; }))
            .rangeRoundBands([0, 500], .1);

        var y;

        if(value == "price"){
          y = d3.scale.linear()
              .domain([0, d3.max(newstat, function(d) { return d.price; }) * 1.1])
              .range([420, 0]);
        } else{
          y = d3.scale.linear()
              .domain([70, d3.max(newstat, function(d) { return d.rating; }) * 1.1])
              .range([420, 0]);
        }

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

        chart.select(".xaxis")
            .transition().duration(1000)
            .call(xAxis)
            .selectAll("text")
            .style("font-size","12px")
            .style("font-family", "sans-serif");

        chart.select(".yaxis")
            .transition().duration(1000)
            .call(yAxis)
            .selectAll("text")
            .style("font-size","12px")
            .style("font-family", "sans-serif");

        var bar = chart.selectAll(".bar")
            .data(newstat, d=>d.province);

        if(value == "price"){
          bar.enter().append("rect")
              .attr("class", "bar")
              .attr("x", function(d) { return x(d.province); })
              .attr("y", function(d) { return y(d.price); })
              .attr("width", x.rangeBand())
              .attr("height", 0)
              .transition().duration(1000)
              .style("fill", function(d) { return color(d.province); });

          bar.each(function(d){
            d3.select(this).transition().duration(1000)
              .attr("x", function(d) { return x(d.province); })
              .attr("y", function(d) { return y(d.price); })
              .attr("height", function(d) { return 420 - y(d.price); })
          })

          var text = chart.selectAll(".tvalue")
              .transition().duration(1000)
              .attr("x", function(d){ return x(d.province);})
              .attr("y", function(d){return y(d.price) ;})
              .text(function(d) { return d3.format("$.2f")(d.price);})
              .style("font-family", "sans-serif")
              .style("font-size","12px");

          text.each(function(d){
            d3.select(this).transition().duration(1000)
              .attr("x", function(d){ return x(d.province);})
              .attr("y", function(d){return y(d.price) ;})
              .text(function(d) { return d3.format("$.2f")(d.price);})
          })

          d3.selectAll(".tvalues").attr("transform", "translate(" + 0 + "," + -30 + ")");

        } else{
          bar.enter().append("rect")
              .attr("class", "bar")
              .attr("x", function(d) { return x(d.province); })
              .attr("y", function(d) { return y(d.rating); })
              .attr("width", x.rangeBand())
              .attr("height", 0)
              .transition().duration(1000)
              .style("fill", function(d) { return color(d.province); });

          bar.each(function(d){
            d3.select(this).transition().duration(1000)
              .attr("x", function(d) { return x(d.province); })
              .attr("y", function(d) { return y(d.rating); })
              .attr("height", function(d) { return 420 - y(d.rating); })
          })

          var text = chart.selectAll(".tvalue")
              .transition().duration(1000)
              .attr("x", function(d){ return x(d.province);})
              .attr("y", function(d){return y(d.rating) ;})
              .text(function(d) { return d3.format("0.2f")(d.rating);})
              .style("font-family", "sans-serif")
              .style("font-size","12px");

          text.each(function(d){
            d3.select(this).transition().duration(1000)
              .attr("x", function(d){ return x(d.province);})
              .attr("y", function(d){return y(d.rating) ;})
              .text(function(d) { return d3.format("0.2f")(d.rating);})
          })

          d3.selectAll(".tvalues").attr("transform", "translate(" + 0 + "," + -30 + ")");
        }
      }
    }

    var regionStatColor = d3.scale.ordinal()
	 .range(["#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c"]);
    let init = true;
    let currentReg;
    let regionCurrentCtr;
    function regionStat(cid, rid, list) { //cid: country name, rid: region name
      console.log("regionStat called.");

      if (list === undefined) {
	      list = fullData
      }
      currentReg = rid;
      if (cid == undefined) {
        cid = regionCurrentCtr;
      } else {
        regionCurrentCtr = cid;
      }

      var country_filtered = countryFilter(list, cid)
      var province_filtered = country_filtered.filter(function(dd) { return dd.province == rid })

      data = provinceStat(province_filtered)
      let var_length = data[data.length-1]
      let var_data = data.slice(0, var_length)
      let win_data = data.slice(var_length, data.length-1)

      let x = d3.scale.linear()
          .range([0, 480])

      let y = d3.scale.ordinal()
          .rangeRoundBands([0, 350])

      let xAxis = d3.svg.axis()
          .scale(x)
          .orient("bottom")

      let yAxis = d3.svg.axis()
          .scale(y)
          .orient("left")

      x.domain([50, 98])
      y.domain(var_data.map(function(d) { return d.variety }))

      if (init) {
        init = false

        variety_plot.append('text')
        .attr("x", 300*(100-rid.length)/100)
        .attr("y", 30)
        .text(rid)
        .attr('class', 'title')
        .style("font-weight", "bold")
        .style("font-size","25px")
        .style("font-family", "sans-serif");

        variety_plot.append('text')
        .attr("x", 63)
        .attr("y", 65)
        .text("Variety")
        .style("font-weight", "bold")
        .style("font-size","20px")
        .style("font-family", "sans-serif");;

        variety_plot.append('text')
        .attr("x", 575)
        .attr("y", 490)
        .text("Rating")
        .style("font-weight", "bold")
        .style("font-size","20px")
        .style("font-family", "sans-serif");

        variety_plot.append('g')
          .attr('class', 'xaxis')

        variety_plot.append('g')
          .attr('class', 'yaxis')
      }

      variety_plot.selectAll('.xaxis')
        .call(xAxis)
        .attr('transform', 'translate(135,' + 430 +")")
        .selectAll("text")
        .style("font-size","14px")
        .style("font-family", "sans-serif")
        .transition()
        .duration(400)

      variety_plot.selectAll('.yaxis')
        .call(yAxis)
        .style('stroke', 'blue')
        .style('stroke-width', '0.2px')
        .attr('transform', 'rotate(-90)')
        .attr('transform', function() {
          if (var_length == 1) {
            return 'translate(135,' + -60 +")"
          }
          if (var_length == 2) {
            return 'translate(135,' + 30 +")"
          }
          if (var_length == 3) {
            return 'translate(135,' + 57 +")"
          }
          if (var_length == 4) {
            return 'translate(135,' + 72 +")"
          }
          else {
            return 'translate(135,' + 82 +")"
          }
        })
        .selectAll('text')
          .attr("x", "7")
          .attr("y", "-22")
          .attr('transform', 'rotate(-65)')
          .style("font-size","14px")
          .style("font-family", "sans-serif")
        .transition()
        .duration(400)

      variety_plot.selectAll('.title')
        .attr("x", 300*(100-rid.length)/100)
        .attr("y", 30)
        .text(rid)
        .attr('class', 'title')
        .style("font-weight", "bold")
        .style("font-size","25px")
        .style("font-family", "sans-serif");

      var bText = variety_plot
        .selectAll(".tvalue")
        .data(var_data, d => d.variety);

      bText.exit()
           .remove()

      bText.enter().append("text")
           .attr("class", "tvalue")
           .attr("y", function(d){return y(d.variety);})
           .attr("x", function(d){ return 0 ;})
           .attr("transform", "translate(" + 140 + "," + 116 + ")")
           .text(function(d) { return d3.format(".2f")(d.rating);})
           .style("font-family", "sans-serif")
           .style("font-size","12px")
            .attr('opacity', 0)

      bText
           .attr("transform", "translate(" + 140 + "," + 116 + ")")
           .attr("y", function(d){return y(d.variety);})
           .attr('opacity', 0)
           .transition()
           .duration(800)
           .attr('opacity', 1)
           .text(function(d) { return d3.format(".2f")(d.rating);})
           .attr("x", function(d){ return x(d.rating) ;})

      let bars = variety_plot.selectAll('.var_bars')
          .data(var_data, d=>d.variety)

      bars.exit()
          .remove()

      bars.enter()
          .append('rect')
          .attr('class', 'var_bars')
          .attr('transform', 'translate(135, 90)')
          .attr("width", function(d) { return 0 } )
          .style("fill", function(d) { return regionStatColor(d.variety); })
          //.style("fill", "#7b6888")
          .attr('opacity', 0)
       /*   .on('mouseover', function(d) {
            d3.selectAll('.win_bars')
              .style('filter', function(dd) {
                console.log(dd)
                if (dd.variety == d.variety) {
                  return 'brightess(120%)';
                }
                else {
                  return null;
                }
              })
          })*/
          .on('mousemove', barMouseOver)
          .on("mouseout", barMouseOut)
          .transition()

      bars
          .attr("height", 50)
          .attr("y", function(d) { return y(d.variety); })
          .attr('transform', 'translate(135,' + 90 +")")
          .attr("width", function(d) { return 0; } )
          .attr('opacity', 0)
          .transition()
          .duration(800)
          .attr("width", function(d) { return x(d.rating);} )
          .attr('opacity', 1)
          .style("fill", function(d) { return regionStatColor(d.variety); });

          regionStat2(win_data)


    }

    init2 = true
    function regionStat2(win_data) {
      let x = d3.scale.linear()
	  .range([0, 480])
      let y = d3.scale.ordinal()
	  .rangeRoundBands([0, 350])
      let xAxis = d3.svg.axis()
	  .scale(x)
	  .orient("bottom")
      let yAxis = d3.svg.axis()
	  .scale(y)
	  .orient("left")
      //xMax = d3.max(win_data, function(d) { return d.rating; }
      x.domain([50, 98])
      y.domain(win_data.map(function(d) { return d.winery }))

       if (init2) {
        init2 = false


        winery_plot.append('text')
        .attr("x", 63)
        .attr("y", 65)
        .text("Winery")
        .style("font-family", "sans-serif")
        .style("font-size", "20px")
        .style("font-weight", "bold");

        winery_plot.append('text')
        .attr("x", 575)
        .attr("y", 480)
        .text("Rating")
        .style("font-family", "sans-serif")
        .style("font-size", "20px")
        .style("font-weight", "bold");

        winery_plot.append('g')
          .attr('class', 'xaxis')

        winery_plot.append('g')
          .attr('class', 'yaxis')
      }

      winery_plot.selectAll('.xaxis')
        .call(xAxis)
        .attr('transform', 'translate(135,' + 430 +")")
        .selectAll("text")
        .style("font-size","14px")
        .style("font-family", "sans-serif")
        .transition()
        .duration(400)

      winery_plot.selectAll('.yaxis')
        .call(yAxis)
        .style('stroke', 'blue')
        .style('stroke-width', '0.2px')
        .attr('transform', 'rotate(-90)')
        .attr('transform', function() {
          if (win_data.length == 1) {
            return 'translate(135,' + -60 +")"
          }
          if (win_data.length == 2) {
            return 'translate(135,' + 30 +")"
          }
          if (win_data.length == 3) {
            return 'translate(135,' + 57 +")"
          }
          if (win_data.length == 4) {
            return 'translate(135,' + 72 +")"
          }
          else {
            return 'translate(135,' + 82 +")"
          }
        })        .selectAll('text')
          .attr("x", "7")
          .attr("y", "-22")
          .attr('transform', 'rotate(-65)')
          .style("font-size","14px")
          .style("font-family", "sans-serif")
        .transition()
        .duration(400)

      var bText = winery_plot
        .selectAll(".tvalue")
        .data(win_data, d => d.winery);

      bText.exit()
           .remove()

      bText.enter().append("text")
           .attr("class", "tvalue")
           .attr("y", function(d){return y(d.winery);})
           .attr("x", function(d){ return 0 ;})
           .attr("transform", "translate(" + 140 + "," + 116 + ")")
           .text(function(d) { return d3.format(".2f")(d.rating); })
           .style("font-family", "sans-serif")
           .style("font-size","12px")

      bText.transition()
           .duration(800)
           .text(function(d) { return d3.format(".2f")(d.rating); })
           .attr("y", function(d){return y(d.winery);})
           .attr("x", function(d){ return x(d.rating) ;})
           .attr("transform", "translate(" + 140 + "," + 116 + ")")

      let bars = winery_plot.selectAll('.win_bars')
          .data(win_data, d=>d.winery)

      bars.exit()
          .remove()

      bars.enter()
          .append('rect')
          .attr('class', 'win_bars')
          .attr('transform', 'translate(135, 90)')
          .attr("width", function(d) { return 0 } )
          .style("fill", function(d) { return regionStatColor(d.winery); })
          .attr('opacity', 0)
          .on('mousemove', barMouseOver)
          .on("mouseout", barMouseOut)
          .transition()

      bars
          .attr("height", 50)
          .attr("y", function(d) { return y(d.winery); })
          .attr('transform', 'translate(135,' + 90 +")")
          .attr("width", function(d) { return 0; } )
          .attr('opacity', 0)
          .transition()
          .duration(800)
          .attr("width", function(d) { return x(d.rating);} )
          .attr('opacity', 1)
          .style("fill", function(d) { return regionStatColor(d.winery); })
    }


    // jhlim: below functions are fixed (no more changes needed)
    // draw countries color
    function countryFill() {
      for(let i=0; i<ctr_records.length; i++) {
        d3.select('#' + ctr_records[i].id)
          .attr('fill', function() {
	    if(+ctr_records[i].values.length === 0)
		return '#ECEFF1';
	    else {
        return popScale(Math.log10(+ctr_records[i].values.length));};
        });
      }
    }
    function countryUnfill() {
      d3.selectAll('.country')
        .attr('fill', '#ECEFF1'); //base color
    }
    // draw region points
    function regionPoint() {
	  console.log("regionPoint called");
      g.selectAll('circle').remove();
      for(let i=0; i<ctr_records.length; i++) {
        g.selectAll('circle')
          .data(ctr_records[i].provinces, d => d.province)
          .enter()
          .append('circle')
          .attr('class', 'region')
          .attr('r', d => radiusScale(d.record_count))
          .style('fill', d => popScale2(d.rating))
          .style('opacity', 0.8)
          .attr('transform', function(d) {
            temp = projection([+d.lng, +d.lat]);
            temp[0] = temp[0] + rotateVal;
            return 'translate(' + temp + ')'})
          .on("click", function(d, i) {
            selected(d);
            regionStat(d.country, d.province, fList); // hmlee
          })
          .on("mousemove", showPointTooltip)
          .on("mouseout",  function(d,i) {
              tooltip.classed("hidden", true);
           });
      }
    }

    function showPointTooltip(d) {
      if(viewDegree === "region") {
      label = '&nbsp&nbsp&nbsp' + d.province + '</br>' +
			  'records: ' + d3.format(',')(d.record_count) + '</br>' +
			  'ratings: ' + d3.format('.2f')(d.rating) + '</br>' +
			  'price: ' + d3.format('.2f')(d.price) + '</br>';
        var mouse = d3.mouse(svg.node())
          .map( function(d) { return parseInt(d); })
        tooltip.classed("hidden", false)
          .attr("style", "left:"+(mouse[0]+offsetL)+"px;top:"+(mouse[1]+offsetT)+"px")
          .html(label);
      }
    }

    function getCountryData(id) {
		var data = ctr_records.filter(function(d) { return d.id == id});
		return data[0];
    }
    function showTooltip(d) {
      if(viewDegree === "country") {
        var data = getCountryData(d.id);

        if(data === undefined)
          label = d.properties.name;
        else {
          var avg_rating = d3.mean(data.values, d => d.points);
          var avg_price = d3.mean(data.values, d => d.price);

          label = '&nbsp&nbsp&nbsp' + d.properties.name + '</br>' +
                  'records: ' + d3.format(',')(data.values.length) + '</br>' +
                  'ratings: ' + d3.format('.2f')(avg_rating) + '</br>' +
                  'price: ' + d3.format('.2f')(avg_price) + '</br>';
        }
        var mouse = d3.mouse(svg.node())
          .map( function(d) { return parseInt(d); } );
        tooltip.classed("hidden", false)
          .attr("style", "left:"+(mouse[0]+offsetL)+"px;top:"+(mouse[1]+offsetT)+"px")
          .html(label);

      }
    }

    function selected(d) {
      console.log(d);
      // 1) country selected
      if(d.id !== undefined) {
        if(currentCtr !== d.id) {
          country_plot1.selectAll('g').remove();
          country_plot1.selectAll('text').remove();
          country_plot2.selectAll('g').remove();
          currentCtr = d.id;
          countryChart(currentCtr);
        }
      }
      // 2) state selected
      else if(d.properties !== undefined) {
        if(currentCtr !== 'USA') {
          country_plot1.selectAll('g').remove();
          country_plot1.selectAll('text').remove();
          country_plot2.selectAll('g').remove();
          currentCtr = 'USA';
          countryChart(currentCtr);
        }
      }
      // 3) point selected
      else if(d.province !== undefined) {
        if(currentCtr !== d.country) {
          country_plot1.selectAll('g').remove();
          country_plot1.selectAll('text').remove();
          country_plot2.selectAll('g').remove();
          currentCtr = d.country;
          countryChart(currentCtr);
        }
      }

      countryUnfill();

      if(viewDegree === "country") {
        countryFill();
	if(getCountryData(d.id) !== undefined)
	  d3.select(this)
            .attr('fill', d3.hsl(popScale(Math.log10(+getCountryData(d.id).values.length))).darker(0.5));

      }
      else if(viewDegree == "region") {
      console.log(d);
      }
    }
    function translate(x, y) {
      return 'translate(' + x + ', ' + y + ')';
    }
    function zoomIn() {
      viewDegree = "region";

      states
        .classed('hidden', false);
      usa
        .classed('hidden', true);
      legendSvg
	.classed('hidden', true);

      countryUnfill();
      regionPointVisible();
    }
    function zoomOut() {
      viewDegree = "country";

      states
        .classed('hidden', true);
      usa
        .classed('hidden', false);
      legendSvg
	.classed('hidden', false);

      countryFill();
      regionPointHidden();
    }

    function regionPointVisible() {
      d3.selectAll('.region')
        .style('visibility', 'visible');
    }
    function regionPointHidden() {
      d3.selectAll('.region')
        .style('visibility', 'hidden');
    }
    function rotateMap(endX) {
        projection.rotate([rotated + (endX - initX) * 360 / (s * width),0,0])
            g.selectAll('path')       // re-project path data
           .attr('d', path);
        rotateVal = (rotated + (endX - initX) * 360 / (s * width));

        d3.selectAll('.region')
           .attr('transform', function(d) {
           temp = projection([d.lng, d.lat]);
           return 'translate(' + temp + ')'})
    }

    var legendFullHeight = 150;
    var legendFullWidth = 120;
    var legendMargin = { top: 20, bottom: 20, left: 10, right: 10};
    var legendWidth = legendFullWidth - legendMargin.left - legendMargin.right;
    var legendHeight = legendFullHeight - legendMargin.top - legendMargin.bottom;
    var legendSvg, legendSvg2;

    function drawLegend() {
      if(legendSvg !== undefined)
	legendSvg.selectAll('*').remove();
      legendSvg = d3.select('body').append('svg').style('border', '0px')
      .style('top', (height - 100) + 'px')
      .style('left', '14px')
      .attr('opacity', 0.8)
      .attr('width', legendFullWidth+20)
      .attr('height', legendFullHeight)
      .append('g')
      .attr('transform', 'translate(' + legendMargin.left + ',' +
      legendMargin.top + ')');

      legendSvg.append('text')
        .text("log(# of records)")
        .style("font-size", "16px")
        .style("font-weight", "bold")
        .attr('opacity', 0.9)

    var gradient = legendSvg.append('defs')
      .append('linearGradient')
      .attr('id', 'gradient')
      .attr('x1', '0%')
      .attr('y1', '100%')
      .attr('x2', '0%')
      .attr('y2', '0%')
      .attr('spreadMethod', 'pad');

    var pct = linespace(0, 100, myColorScales.length).map(function(d) { return Math.round(d) + '%'; });

    var colourPct = d3.zip(pct, myColorScales);

    colourPct.forEach(function(d) {
        gradient.append('stop')
            .attr('offset', d[0])
            .attr('stop-color', d[1])
            .attr('stop-opacity', 1);
    });

    legendSvg.append('rect')
        .attr('x1', 0)
        .attr('y1', 1000)
        .attr('width', 30)
        .attr('height', legendHeight)
        .style('fill', 'url(#gradient)')
        .attr('transform', translate(legendWidth-70, 5));

    	var legendScale = d3.scale.linear()
            .domain([1, d3.max(ctr_records, d=>Math.log10(+d.values.length))])
	    .range([legendHeight, 0]);

    	var legendAxis = d3.svg.axis()
            .scale(legendScale)
	    .orient("right")
    	    .ticks(5, 2);

	legendSvg.append("g")
    	    .attr("class", "legend axis")
            .attr("transform", translate(legendWidth-40, 5))
            .call(legendAxis);
    }

    //filter for a specific country
    function countryFilter(data, ctr_code){
      var result = data.filter(function(d) { return d.ctr_code == ctr_code })

      return result;
    }

    //filter for points and price
    function filter(data){
      var min = Number(d3.select('#min').property('value'));
      var max = Number(d3.select('#max').property('value'));
      var rating = Number(d3.select("text#slider").text());

      var result = [];

      if(max === 0 && min > 0){
        data.forEach(function(d){
      	  if(d.points >= rating && d.price >= min){
      	      result.push(d);
      	  }
      	})
      } else if(max > 0 && min === 0){
    	  data.forEach(function(d){
          if(d.price <= max && d.points >= rating){
            result.push(d);
          }
        })
      } else if(max > 0 && min > 0){
        data.forEach(function(d){
          if(d.price <= max && d.price >= min && d.points >= rating){
            result.push(d);
          }
        })
      } else {
        data.forEach(function(d){
          if(d.points >= rating){
            result.push(d);
          }
        })
      }
      return result;
    }


    // hmlee
    // calculate statistic for specific country (ex. data which is filtered for USA)
    function countryStat(data) {

      let visited = d3.set()
      let province_list = []
      let rating_reducer = function (accumulator, currentValue) { return accumulator + (+currentValue.points) }
      let price_reducer = function (accumulator, currentValue) { return accumulator + (+currentValue.price) }

      data.forEach(function(d) {
        let prov = d.province
        if (!visited.has(prov)) {
          visited.add(prov)
          let prov_data = data.filter(function(d) { return d.province == prov })

          // mean rating, mean price
          let rating = d3.round(prov_data.reduce(rating_reducer, 0) / prov_data.length, 3)
          let price = d3.round(prov_data.reduce(price_reducer, 0) / prov_data.length, 3)

          let winery_set = d3.set()
          prov_data.forEach(function (dd) {
            winery_set.add(dd.winery)
          })

          province_list.push({'province':prov, 'record_count':prov_data.length, 'winery_count':winery_set.size(), 'rating': rating, 'price': price})
        }
      })

      province_list.sort(function (a, b) {
        if (a.winery_count > b.winery_count)
          return -1
        if (a.winery_count < b.winery_count)
          return 1
        return 0
      })

      if (province_list.length > 5) {
        province_list = province_list.slice(0, 5)
      }
      province_list.forEach(function(d, i) {
        d['rank'] = i
      })
      // return top 5 provinces
      return province_list
    }

	// jhlim: get stats of all regions.
    function countryStatAll(cid, data) {
      let visited = d3.set()
      let province_list = []
      let rating_reducer = function (accumulator, currentValue) { return accumulator + (+currentValue.points) }
      let price_reducer = function (accumulator, currentValue) { return accumulator + (+currentValue.price) }

      data.forEach(function(d) {
        let prov = d.province
        if (!visited.has(prov)) {
          visited.add(prov)
          let prov_data = data.filter(function(d) { return d.province == prov })

          // mean rating, mean price
          let rating = d3.round(prov_data.reduce(rating_reducer, 0) / prov_data.length, 3)
          let price = d3.round(prov_data.reduce(price_reducer, 0) / prov_data.length, 3)

          let winery_set = d3.set()
          prov_data.forEach(function (dd) {
            winery_set.add(dd.winery)
          })

          let lat = prov_data[0].lat;
          let lng = prov_data[0].lng;

          province_list.push({'province':prov, 'record_count':prov_data.length, 'winery_count':winery_set.size(), 'rating': rating, 'price': price, 'lat': lat, 'lng': lng, 'country': cid})
        }
      })

      // return top 5 provinces
      return province_list
    }

    // hmlee
    // calculate statistic for specific province (ex. California)
    function provinceStat(data)  {
      let visited = d3.set()
      let variety_list = []
      let visited_winery = d3.set()
      let winery_list = []
      let rating_reducer = function (accumulator, currentValue) { return accumulator + (+currentValue.points) }
      let price_reducer = function (accumulator, currentValue) { return accumulator + (+currentValue.price) }

      let rating, price
      data.forEach(function (d) {
        let variety = d.variety
        if (!visited.has(variety)) {
          visited.add(variety)
          let variety_data = data.filter(function(d) { return d.variety == variety })

          rating = d3.round(variety_data.reduce(rating_reducer, 0) / variety_data.length, 3)
          price = d3.round(variety_data.reduce(price_reducer, 0) / variety_data.length, 3)

          variety_list.push({'variety':variety, 'record_count':variety_data.length, 'rating': rating, 'price': price})
        }

      	let winery = d.winery
        if (!visited_winery.has(winery)) {
          visited_winery.add(winery)
          let winery_data = data.filter(function(d) { return d.winery == winery })

          rating = d3.round(winery_data.reduce(rating_reducer, 0) / winery_data.length, 3)
          price = d3.round(winery_data.reduce(price_reducer, 0) / winery_data.length, 3)

          winery_list.push({'winery':winery, 'record_count':winery_data.length, 'rating':rating, 'price': price})
        }
      })

      variety_list.sort(function (a, b) {
        if (a.rating > b.rating)
          return -1
        if (a.rating < b.rating)
          return 1
        return 0
      })

      winery_list.sort(function (a, b) {
	  if (a.rating > b.rating)
	      return -1
	  if (a.rating < b.rating)
	      return 1
	  return 0
      })

      if (variety_list.length > 5) {
        variety_list = variety_list.slice(0, 5)
      }
      variety_list.forEach(function(d, i) {
        d['rank'] = i
        d['total'] = variety_list.length
      })

      if (winery_list.length > 5) {
        winery_list = winery_list.slice(0, 5)
      }
      winery_list.forEach(function(d, i) {
        d['rank'] = i
        d['total'] = winery_list.length
      })

      let result = variety_list.concat(winery_list)
      result.push(variety_list.length)
      // return top 5 varieties
      return result
    }
  </script>
</body>
</html>
